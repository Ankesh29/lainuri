<html>
  <meta charset="UTF-8">
  <head>
    <title>Lainuri javascript client</title>
    <!-- Use the development files or the bundled distributable -->
    <script src='lainuri.js' type='text/javascript'></script>
    <!-- Production dependencies
    <script src="dist/lainuri.0.0.1.min.js"></script>
    <!-- -->
  </head>
  <body>

    <div id="rfid_tags"></div>
    <legend>
      <label for="rtttl_ringtone">  RTTTL ringtone:  <input type="text"  id="rtttl_ringtone"  placeholder="ToveriAccessGranted:d=4,o=5,b=100:32c5,32b4,32c5,4d5"/></label><br/>
      <input type="button" id="triggerTest" value="Play" onclick="play_rtttl()"><br/>
      <div id='rtttl_console'></div>
    </legend>

    <script type="text/javascript">

'use strict'

// Keep track of active pending events that need to be canceled.
let events = {};

const lainuri = new Lainuri('ws://localhost:53153');

lainuri.attach_event_listener(LEException, function(event) {
  console.log(`Event '${LEException.name}' received!`, event, event.exception);

  if (events[event.event_id]) {
    // If this exception-event is for the "ringtone playing" -event, we can notify the UI that the event
    // has failed.
    if (event.event_id.indexOf(LERingtonePlayed.event)) {
      document.getElementById('rtttl_console').innerHTML(event.message);
    }
  }
});
lainuri.attach_event_listener(LERingtonePlay, function(event) {
  console.log(`Event '${LERingtonePlay.name}' triggered.`);
});
lainuri.attach_event_listener(LERingtonePlayed, function(event) {
  console.log(`Event '${LERingtonePlayed.name}' triggered.`);
  document.getElementById('rtttl_console').innerHTML("Finished playing: " + event.message);
});
lainuri.attach_event_listener(LEConfigWrite, function(event) {
  console.log(`Event '${LEConfigWrite.name}' triggered.`);
});
lainuri.attach_event_listener(LERFIDTagsNew, function(event) {
  console.log(`Event '${LERFIDTagsNew.name}' triggered. New RFID tags:`, event.tags_new, event.tags_present);
});
lainuri.attach_event_listener(LERFIDTagsLost, function(event) {
  console.log(`Event '${LERFIDTagsLost.name}' triggered. New RFID tags:`, event.tags_lost, event.tags_present);
});
lainuri.attach_event_listener(LERFIDTagsPresent, function(event) {
  console.log(`Event '${LERFIDTagsPresent.name}' triggered. Present RFID tags:`, event.tags_present);
});
lainuri.attach_event_listener(LEServerDisconnected, function(event) {
  console.log(`Event '${LEServerDisconnected.name}' triggered.`);
});
lainuri.attach_event_listener(LEServerConnected, function(event) {
  console.log(`Event '${LEServerConnected.name}' triggered.`);

  lainuri.dispatch_event(
    //new LERingtonePlay('success', undefined, 'client', 'server')
    new LERingtonePlay(undefined, 'ToveriAccessGranted:d=4,o=5,b=100:32c5,32b4,32c5,4d5', 'client', 'server')
  );
  lainuri.dispatch_event(
    new LEConfigWrite('missing.variable', 'bad-value', 'client', 'server')
  );
});

lainuri.open_websocket_connection();


function play_rtttl() {
  let ringtone = document.getElementById('rtttl_ringtone');
  let play_event = new LERingtonePlay(undefined, ringtone, 'client', 'server');
  // Persist reference to the event which is pending for the completion message from the server
  events[play_event.event_id] = play_event;
  lainuri.dispatch_event(play_event);
}


    </script>
  </body>
</html>